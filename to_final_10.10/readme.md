# Резюме по DS части проекта

### В данной папке репозитория мы представляем для ревью следующие материалы:

1. Ноутбук с EDA
2. Ноутбук с нашими наработками по исследованию кластеризации
3. Ноутбук с моделью 1. Мы разработали ее для прогноза спроса на наиболее продаваемые товары, пользующиеся стабильным спросом
4. Ноутбук с моделью 2. Эта модель создана для прогноза редких и нерегулярно продаваемых товаров
5. Ноутбук с применением библиотеки tsfresh для создания признаков
6. Файл model.py с функцией forecast для интеграции с другими микросервисами нашего приложения (бэкенд, база данных)
7. Ноутбук где мы тестируем эту функцию, имитируя подачу ей на вход данных из БД
8. Файл submission.csv с прогнозом нашей модели

### Наш путь

Наш подход к решению задачи заключался в том, что все сочетания товар-магазин можно условно поделить на:

1. Пары с высокими продажами и/или стабильным спросом. Мы можем прогнозировать их, используя собственную статистику каждой пары товар-магазин отдельно, для этого достаточно данных.
2. Остальные пары, для которых характерны низкие продажи и большое количество дней с нулевыми продажами. Мы будем прогнозировать их используя статистику по товару (продажи по всем магазинам) и магазину (продажи всех товаров в этом магазине)

**Проблема, с которой мы столкнулись, перенося решение на прод:**

Если для первой модели мы базируем признаки для второго и последующих дней на том, что прогнозируем (продажи товар-магазин), то для второй модели нам требуются аггрегированные продажи по товару и по магазину. А их мы не прогнозируем, у нас нет таких данных. 

**Наше решение:**

В этой связи в рамках проекта нам пришлось отказаться от второй модели, хотя мы считаем перспективным и заслуживающим дальнейшей проработки подход с кластеризацией товаров в зависимости от объемов и стабильности их продаж. Необходимо только разработать признаки, которые будут доступны на инференсе

**Последствия перехода к исключительно первой модели (товар-магазин):**

(По этой причине мы не хотели использовать единственную модель в начале) временные ряды товар-магазин заполнились большим количеством нулевых продаж из-за редко продаваемых товаров. Из-за них же снизилось качество прогноза - изначально метрика первой модели была значительно выше

**Путь решения:**

В целях улучшения метрики мы считаем правильным использовать библиотеку tsfresh. К сожалению, мы оказались на этом этапе всего за пару дней до сдачи проекта, а библиотека требует времени на освоение и корректное применение. В нашем случае новые признаки не улучшили метрику значительно и не были распознаны моделью как важные, значительно при этом увеличивая объем работ в части прогноза. В случае работы над проектом после окончания хакатона мы видим путь к улучшению метрики в использовании правильных признаков, извлеченных tsfresh

### Модель и признаки

Мы остановили свой выбор на градиентном бустинге LightGBM

Кроме признаков, уже присутствующих в датасете (айди товара, айди магазина и др.), мы использовали традиционные для прогноза временных рядов лаговые признаки и скользящие средние, расчетную среднедневную цену товара, а также средний процент скидки в случаях, когда товар продавался по промо

**Feature importances модели (в порядке убывания важности) и наша трактовка:**

1. Товар-магазин
2. Айди товара
3. Среднедневная цена
4. Продажи вчера (лаг 1)
5. Номер недели
6. Средние продажи за 2 последних дня
7. День недели
8. Скидка
9. Продажи ровно неделю назад (лаг 7)
10. Продажи две недели назад (лаг 14)
11. День месяца (число)
12. Продажи три неделди назад (лаг 21)

* С позиции здравого смысла мы согласны с такой логикой. 

* В первую очередь играет роль какой-то свой, присущий каждому товару диапазон продаж. Кроме того, он специфичен для каждого отдельного магазина. 

* Сильное влияние цены также оправданно: мы знаем из экономической модели спроса и предложения, что снижение цены - отличное средство подстегнуть спрос.

* Один из аспектов цены - скидка. Мы посчитали важным хотя бы приблизительно рассчитать процент скидки, имея в виду, что значительная скидка сильнее увеличит спрос, чем маленькая символическая. И действительно этот признак оказался важнее, нежели просто бинарный флаг промо

* Временной ряд обладает определенной инерцией - на это указывает важная роль вчерашних продаж, а также среднее между продажами вчера и позавчера

* Модель выявляет тренд: у нас всего один год наблюдений, поэтому номер недели отвечает не за сезонность, а за тренд

* Зато очень сильна сезонность недельная, на это указывает сразу группа признаков: день недели и лаги, кратные 7. На некоторых итерациях вперед выступали также лаги, кратные 7 +- 1. Модель видит повышение продаж в выходные по сравнению с будними днями

* Мы пытались учесть праздники, отметив при этом, что рост продаж приходится не на день праздника, а за 1-4 дня до него. Однако модель не идентифицировала этот признак как значимый. Мы полагаем, что было бы иначе, если бы модель обучалась на данных нескольких лет, где на одни и те же даты ежегодно приходится рост продаж

* День месяца также оказался важным признаком. Это может быть связано с тем, что определенные числа являются традиционными днями зарплаты, временно увеличивая покупательскую способность населения.




